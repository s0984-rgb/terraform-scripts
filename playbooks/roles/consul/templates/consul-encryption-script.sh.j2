#!/usr/bin/env bash

source {{ vault_agent_rendered_dir }}/logger.sh

# Setup Consul address info
export CONSUL_HTTP_ADDR="https://localhost:8501"
export CONSUL_CLIENT_CERT="{{ consul_certificate }}"
export CONSUL_CLIENT_KEY="{{ consul_key }}"
export CONSUL_CACERT="{{ consul_ca }}"

# The new key will be in a file generated by consul-template
# the script retrieves the key from the file
NEW_KEY=`cat {{ vault_agent_rendered_dir }}/consul.key | sed -e '/^$/d'`

CONSUL_PID=`pidof -q 'consul'`
if [ -z $CONSUL_PID ]; then
  logError "Consul not started"
  exit 0
fi

# Install the key
logInfo "Install new encryption key"
consul keyring -install ${NEW_KEY}

# Set as primary
logInfo "Setting new key as primary"
consul keyring -use ${NEW_KEY}

# Retrieve all keys used by Consul
KEYS=`curl -s ${CONSUL_HTTP_ADDR}/v1/operator/keyring --cacert ${CONSUL_CACERT} --cert ${CONSUL_CLIENT_CERT} --key ${CONSUL_CLIENT_KEY}`

ALL_KEYS=`echo ${KEYS} | jq -r '.[].Keys| to_entries[].key' | sort | uniq`
logInfo "Removing all old keys"
for i in `echo ${ALL_KEYS}`; do
  if [ $i != ${NEW_KEY} ] ; then
    consul keyring -remove $i
  fi
done
